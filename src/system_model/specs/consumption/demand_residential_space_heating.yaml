model_part: demand_residential_space_heating
version: 1.1
tick_s: 1

description: >
  Aggregate Swedish residential *electric* space-heating demand (MW) for a cold winter day.
  Includes: heat pumps (compressor electricity), auxiliary resistive "spets" electricity, and direct electric space heating.
  Excludes: residential non-heating loads (handled by demand_residential_non_heating) and non-electric fuels.
  Horizon: think-ahead <= 24h.

units:
  power: MW
  energy: MWh_th
  time: s
  temperature: C

inputs:
  weather_now_sweden:
    temperature_outdoor_C: float
    wind_speed_mps: float

  weather_forecast_24h:
    step_s: int
    temperature_outdoor_C: [float]   # length = 86400/step_s, index 0 = now
    wind_speed_mps: [float]

  time_now:
    unix_s: int
    local_hour_0_23: int
    local_minute_0_59: int
    local_second_0_59: int
    day_of_week_0_6: int

  demand_response:
    curtailment_frac_0_1: float      # 0=no curtailment; 0.1 => -10% heating demand

state:
  # Smooth outdoor temperature to emulate building/aggregation inertia
  effective_outdoor_temp_C: float

  # Smooth schedule factor to remove discrete jumps (e.g. at 05:00)
  schedule_factor_smooth: float

  # For smoother graphs (optional)
  last_consumption_MW: float

constants:
  # --- Comfort schedule (piecewise, then smoothed) ---
  schedule:
    - [0, 5, 0.88]
    - [5, 9, 1.08]
    - [9, 16, 0.98]
    - [16, 22, 1.10]
    - [22, 24, 0.92]
  tau_schedule_smooth_s: 1800.0     # 30 min smoothing time constant

  # --- Temperature response / losses ---
  heating_balance_temp_C: 17.0
  design_temp_C: -20.0

  # Smoothing for effective outdoor temperature
  building_tau_s: 7200.0            # 2h

  wind_ref_mps: 3.0
  wind_loss_coeff_per_mps: 0.02     # +2% demand per (m/s) above wind_ref_mps

  # --- Scale anchors (tunable; keep realistic) ---
  # Design-day thermal space heating request at temp_factor=1, wind_factor=1, schedule=1, curtailment=0.
  thermal_spaceheat_design_MW: 25000.0

  # --- Heat pump + resistance capacities (electric) ---
  hp_compressor_electric_cap_MW: 4500.0
  hp_aux_resistive_cap_MW: 6500.0
  direct_electric_spaceheat_cap_MW: 3000.0
  hvac_parasitic_MW: 150.0

  # --- Heat pump COP (weighted, simplified) ---
  COP_air_at_7C: 3.0
  COP_air_slope_per_C: 0.045
  COP_air_min: 1.2
  COP_air_max: 3.6

  COP_ground_constant: 3.4
  COP_exhaust_constant: 2.6

  # Stock weights (from small-house heat pump counts)
  n_heatpumps_smallhouses_total: 1286000
  n_heatpumps_smallhouses_air_air: 543000
  n_heatpumps_smallhouses_air_water_or_exhaust: 286000
  n_heatpumps_smallhouses_ground_or_lake: 457000

  w_air_air: "= n_heatpumps_smallhouses_air_air / n_heatpumps_smallhouses_total"
  w_air_water_or_exhaust: "= n_heatpumps_smallhouses_air_water_or_exhaust / n_heatpumps_smallhouses_total"
  w_ground_or_lake: "= n_heatpumps_smallhouses_ground_or_lake / n_heatpumps_smallhouses_total"

  # Split of thermal demand that prefers HP vs direct electric (behavior/stock approximation)
  hp_preferred_thermal_share: 0.70

  # Curtailment clamp
  curtailment_min_factor: 0.70

helpers:
  clamp: "clamp(x,a,b)=min(max(x,a),b)"
  clamp01: "clamp(x,0,1)"

  schedule_lookup: >
    # schedule_lookup(schedule, hour) -> multiplier
    func(schedule, hour):
      for seg in schedule:
        if seg[0] <= hour < seg[1]: return seg[2]
      return 1.0

update_per_tick:
  - t_day_s: "= time_now.local_hour_0_23*3600 + time_now.local_minute_0_59*60 + time_now.local_second_0_59"

  # 1) Smooth outdoor temperature
  - state.effective_outdoor_temp_C: >
      state.effective_outdoor_temp_C
      + (weather_now_sweden.temperature_outdoor_C - state.effective_outdoor_temp_C) * (tick_s / building_tau_s)

  # 2) Compute raw schedule factor (stepwise) then smooth it (Option A)
  - schedule_factor_raw: "= schedule_lookup(schedule, time_now.local_hour_0_23)"
  - state.schedule_factor_smooth: >
      state.schedule_factor_smooth
      + (schedule_factor_raw - state.schedule_factor_smooth) * (tick_s / tau_schedule_smooth_s)

  # 3) Multipliers
  - heating_degree_C: "max(0, heating_balance_temp_C - state.effective_outdoor_temp_C)"
  - heating_degree_design_C: "= heating_balance_temp_C - design_temp_C"
  - temp_factor_0_1: "clamp(heating_degree_C / heating_degree_design_C, 0, 1)"

  - wind_factor: >
      1 + wind_loss_coeff_per_mps * max(0, weather_now_sweden.wind_speed_mps - wind_ref_mps)

  - curtailment_factor: >
      clamp(
        1 - demand_response.curtailment_frac_0_1,
        curtailment_min_factor,
        1.0
      )

  # 4) Requested thermal space heating (MW_th)
  - requested_thermal_spaceheat_MW: >
      thermal_spaceheat_design_MW
      * temp_factor_0_1
      * wind_factor
      * state.schedule_factor_smooth
      * curtailment_factor

  # 5) Allocate requested thermal between HP-preferred and direct-electric-preferred
  - thermal_hp_request_MW: "= requested_thermal_spaceheat_MW * hp_preferred_thermal_share"
  - thermal_direct_request_MW: "= requested_thermal_spaceheat_MW * (1 - hp_preferred_thermal_share)"

  # 6) Weighted COP (weather-driven)
  - COP_air: >
      clamp(COP_air_at_7C - COP_air_slope_per_C * (7 - state.effective_outdoor_temp_C), COP_air_min, COP_air_max)
  - COP_weighted: >
      (w_air_air * COP_air)
      + (w_air_water_or_exhaust * COP_exhaust_constant)
      + (w_ground_or_lake * COP_ground_constant)

  # 7) Heat pump compressor electricity (MW_e), limited by compressor cap
  - hp_compressor_elec_needed_MW: "= thermal_hp_request_MW / COP_weighted"
  - hp_compressor_elec_MW: "min(hp_compressor_electric_cap_MW, hp_compressor_elec_needed_MW)"
  - thermal_served_by_hp_MW: "= hp_compressor_elec_MW * COP_weighted"
  - thermal_hp_remaining_MW: "max(0, thermal_hp_request_MW - thermal_served_by_hp_MW)"

  # 8) Auxiliary resistive electricity to cover unmet thermal (1 MW_e -> 1 MW_th)
  - hp_aux_resistive_elec_MW: "min(hp_aux_resistive_cap_MW, thermal_hp_remaining_MW)"

  # 9) Direct electric space heating (1 MW_e -> 1 MW_th)
  - direct_spaceheat_elec_MW: "min(direct_electric_spaceheat_cap_MW, thermal_direct_request_MW)"

  # 10) Total electric consumption (MW)
  - consumption_MW: >
      hp_compressor_elec_MW
      + hp_aux_resistive_elec_MW
      + direct_spaceheat_elec_MW
      + hvac_parasitic_MW

  - state.last_consumption_MW: "= consumption_MW"

outputs:
  consumption_MW: float
  production_MW: 0.0

  breakdown_MW:
    hp_compressor_elec_MW: float
    hp_aux_resistive_elec_MW: float
    direct_spaceheat_elec_MW: float
    hvac_parasitic_MW: float
    COP_weighted: float
    effective_outdoor_temp_C: "= state.effective_outdoor_temp_C"
    schedule_factor_raw: float
    schedule_factor_smooth: "= state.schedule_factor_smooth"
    temp_factor_0_1: float
    wind_factor: float
    curtailment_factor: float

  forecast_24h:
    step_s: "= weather_forecast_24h.step_s"
    consumption_MW: >
      # Deterministic forecast on the weather grid.
      # Includes schedule smoothing by simulating schedule_factor_smooth forward (same tau).
      let step = weather_forecast_24h.step_s;
      let N = len(weather_forecast_24h.temperature_outdoor_C);
      let out = [];
      let sched_smooth = state.schedule_factor_smooth;
      for i in 0..N-1:
        unix_i = time_now.unix_s + i*step
        derive local_hour from unix_i (your clock actor)
        sched_raw = schedule_lookup(schedule, local_hour)
        sched_smooth = sched_smooth + (sched_raw - sched_smooth) * (step / tau_schedule_smooth_s)

        T = weather_forecast_24h.temperature_outdoor_C[i]
        W = weather_forecast_24h.wind_speed_mps[i]

        heating_degree = max(0, heating_balance_temp_C - T)
        temp_factor = clamp(heating_degree / (heating_balance_temp_C - design_temp_C), 0, 1)
        wind_factor_f = 1 + wind_loss_coeff_per_mps * max(0, W - wind_ref_mps)
        curtail = clamp(1 - demand_response.curtailment_frac_0_1, curtailment_min_factor, 1.0)

        requested_th = thermal_spaceheat_design_MW * temp_factor * wind_factor_f * sched_smooth * curtail
        th_hp = requested_th * hp_preferred_thermal_share
        th_dir = requested_th * (1 - hp_preferred_thermal_share)

        COP_air_f = clamp(COP_air_at_7C - COP_air_slope_per_C * (7 - T), COP_air_min, COP_air_max)
        COP_w = (w_air_air * COP_air_f) + (w_air_water_or_exhaust * COP_exhaust_constant) + (w_ground_or_lake * COP_ground_constant)

        hp_e_need = th_hp / COP_w
        hp_e = min(hp_compressor_electric_cap_MW, hp_e_need)
        th_served_hp = hp_e * COP_w
        th_rem = max(0, th_hp - th_served_hp)
        aux_e = min(hp_aux_resistive_cap_MW, th_rem)

        dir_e = min(direct_electric_spaceheat_cap_MW, th_dir)

        out[i] = hp_e + aux_e + dir_e + hvac_parasitic_MW
      return out
